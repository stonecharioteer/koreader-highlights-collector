{% extends "layout.html" %}

{% block title_suffix %} - Export Jobs{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">Export Jobs</h1>
    {% if jobs %}
    <form method="post" action="{{ url_for('exports.jobs_delete_all') }}" onsubmit="return confirm('Delete all {{ jobs|length }} export job(s) and their files? This cannot be undone.');">
      <button type="submit" class="btn btn-sm btn-outline-danger">
        <i class="fa-solid fa-trash"></i> Delete All
      </button>
    </form>
    {% endif %}
  </div>

  {% if jobs %}
  <div class="list-group">
    {% for job in jobs %}
    <div class="list-group-item">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h5 class="mb-1">
            <a href="{{ url_for('exports.job_status', job_id=job.job_id) }}" class="text-decoration-none">
              {{ job.book.clean_title or job.book.raw_title }}
            </a>
            <span class="badge {% if job.status == 'completed' %}bg-success{% elif job.status == 'failed' %}bg-danger{% elif job.status == 'processing' %}bg-warning{% else %}bg-secondary{% endif %} ms-2">
              {{ job.status }}
            </span>
          </h5>
          <p class="mb-1 text-muted small">
            Template: {{ job.template.name }} •
            Created: <span class="local-time" data-utc="{{ job.created_at.isoformat() }}Z">{{ job.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
            {% if job.completed_at %}
            • Completed: <span class="local-time" data-utc="{{ job.completed_at.isoformat() }}Z">{{ job.completed_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
            {% endif %}
          </p>
        </div>
        <div class="btn-group">
          {% if job.status == 'completed' %}
          <a href="{{ url_for('exports.download', job_id=job.job_id) }}" class="btn btn-sm btn-primary">
            <i class="fa-solid fa-download"></i> Download
          </a>
          {% endif %}
          <form method="post" action="{{ url_for('exports.job_delete', job_id=job.job_id) }}" class="d-inline" onsubmit="return confirm('Delete this export job and its file?');">
            <button type="submit" class="btn btn-sm btn-outline-danger">
              <i class="fa-solid fa-trash"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="fa-solid fa-info-circle"></i> No export jobs yet. Export highlights from any book detail page.
  </div>
  {% endif %}
</div>

<script>
// Convert UTC timestamps to local timezone
document.querySelectorAll('.local-time').forEach(el => {
  const utcTime = el.dataset.utc;
  if (utcTime) {
    const date = new Date(utcTime);
    const options = {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    };
    el.textContent = date.toLocaleString('en-US', options);
  }
});
</script>
{% endblock %}
