{% extends "layout.html" %}

{% block title_suffix %} - Export Job{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Export Job Status</h1>
    <a href="{{ url_for('exports.jobs') }}" class="btn btn-outline-secondary">
      <i class="fa-solid fa-arrow-left"></i> All Jobs
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">{{ job.book.clean_title or job.book.raw_title }}</h5>
      <p class="card-text text-muted">
        <strong>Template:</strong> {{ job.template.name }}<br>
        <strong>Job ID:</strong> <code>{{ job.job_id }}</code><br>
        <strong>Created:</strong> <span class="local-time" data-utc="{{ job.created_at.isoformat() }}Z">{{ job.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span><br>
        {% if job.completed_at %}
        <strong>Completed:</strong> <span class="local-time" data-utc="{{ job.completed_at.isoformat() }}Z">{{ job.completed_at.strftime('%b %d, %Y at %I:%M %p') }}</span><br>
        {% endif %}
      </p>

      <div id="job-status-container">
        <div class="alert alert-{% if job.status == 'completed' %}success{% elif job.status == 'failed' %}danger{% elif job.status == 'processing' %}warning{% else %}info{% endif %}">
          <h6 class="alert-heading">
            {% if job.status == 'completed' %}
            <i class="fa-solid fa-check-circle"></i> Export Completed
            {% elif job.status == 'failed' %}
            <i class="fa-solid fa-exclamation-circle"></i> Export Failed
            {% elif job.status == 'processing' %}
            <i class="fa-solid fa-spinner fa-spin"></i> Processing...
            {% else %}
            <i class="fa-solid fa-clock"></i> Pending
            {% endif %}
          </h6>

          {% if job.status == 'completed' %}
          <p class="mb-0">Your export is ready to download!</p>
          <a href="{{ url_for('exports.download', job_id=job.job_id) }}" class="btn btn-success mt-2">
            <i class="fa-solid fa-download"></i> Download Export
          </a>
          {% elif job.status == 'failed' %}
          <p class="mb-0"><strong>Error:</strong> {{ job.error_message }}</p>
          {% elif job.status == 'processing' %}
          <p class="mb-0">Your export is being processed. This page will update automatically.</p>
          {% else %}
          <p class="mb-0">Your export is queued and will be processed shortly. This page will update automatically.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Convert UTC timestamps to local timezone
document.querySelectorAll('.local-time').forEach(el => {
  const utcTime = el.dataset.utc;
  if (utcTime) {
    const date = new Date(utcTime);
    const options = {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    };
    el.textContent = date.toLocaleString('en-US', options);
  }
});

// Auto-refresh job status if not completed/failed
{% if job.status in ['pending', 'processing'] %}
const jobId = '{{ job.job_id }}';
const statusUrl = '{{ url_for("exports.job_status_json", job_id=job.job_id) }}';

function checkStatus() {
  fetch(statusUrl)
    .then(res => res.json())
    .then(data => {
      if (data.status === 'completed') {
        // Reload page to show download button
        window.location.reload();
      } else if (data.status === 'failed') {
        // Reload page to show error
        window.location.reload();
      } else {
        // Check again in 2 seconds
        setTimeout(checkStatus, 2000);
      }
    })
    .catch(err => {
      console.error('Failed to check status:', err);
      // Retry in 5 seconds
      setTimeout(checkStatus, 5000);
    });
}

// Start polling after 2 seconds
setTimeout(checkStatus, 2000);
{% endif %}
</script>

<style>
  code {
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
  }
  [data-theme="dark"] code {
    background-color: #2a2621;
    color: var(--c-ly);
  }
</style>
{% endblock %}
