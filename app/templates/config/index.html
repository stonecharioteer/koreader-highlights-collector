{% extends 'layout.html' %}
{% block title_suffix %} — Config{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 m-0">Config: Source Folders</h1>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('tasks.trigger_scan') }}">Scan All</a>
</div>

<form method="post" class="row g-2 mb-3" id="add-path-form">
  <div class="col-md-7">
    <input name="path" id="path-input" class="form-control" placeholder="/data/highlights/boox-palma" list="path-suggestions" autocomplete="off" required>
    <datalist id="path-suggestions"></datalist>
  </div>
  <div class="col-md-3">
    <input name="device_label" class="form-control" placeholder="Device label (e.g., boox-palma)">
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-primary">Add Folder</button>
  </div>
</form>

<table class="table table-sm align-middle">
  <thead>
    <tr><th>Path</th><th>Device Label</th><th>Enabled</th><th></th></tr>
  </thead>
  <tbody>
  {% for p in paths %}
    <tr>
      <td><code>{{ p.path }}</code></td>
      <td>
        <form method="post" action="{{ url_for('config.update_label', pid=p.id) }}" class="d-flex gap-2">
          <input name="device_label" class="form-control form-control-sm" value="{{ p.device_label or '' }}" placeholder="Label">
          <button class="btn btn-sm btn-outline-primary">Save</button>
        </form>
      </td>
      <td>{{ 'Yes' if p.enabled else 'No' }}</td>
      <td class="text-end">
        <form method="post" action="{{ url_for('config.toggle', pid=p.id) }}" class="d-inline">
          <button class="btn btn-sm btn-outline-secondary">{{ 'Disable' if p.enabled else 'Enable' }}</button>
        </form>
        <form method="post" action="{{ url_for('config.delete', pid=p.id) }}" class="d-inline ms-1" onsubmit="return confirm('Delete?')">
          <button class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
      </td>
    </tr>
  {% endfor %}
 </tbody>
</table>

<hr class="my-4">

<div class="row g-3">
  <div class="col-lg-6">
    <h2 class="h5">Periodic Scanning</h2>
    <p class="text-muted small mb-2">Configure automatic highlight scanning using cron syntax. The default schedule is every 15 minutes (*/15 * * * *).</p>
    <form method="post" id="scan-schedule-form">
      <div class="mb-2">
        <input name="scan_schedule" id="scan-schedule-input" class="form-control form-control-sm" placeholder="*/15 * * * *" value="{{ cfg.scan_schedule or '*/15 * * * *' }}" required style="max-width: 300px;">
        <small class="text-muted d-block">Format: minute hour day month day_of_week</small>
      </div>
      <div id="schedule-validation" class="mb-2"></div>
      <button class="btn btn-primary btn-sm" id="save-schedule-btn" disabled>Save Schedule</button>
    </form>
  </div>

  <div class="col-lg-6">
    <h2 class="h5">Open Library</h2>
    <p class="text-muted small mb-2">Both fields are required to use Open Library features (search, metadata enrichment).</p>
    <form method="post">
      <div class="mb-2">
        <input name="ol_app_name" class="form-control form-control-sm mb-2" placeholder="App Name (required)" value="{{ cfg.ol_app_name or '' }}" required>
        <input name="ol_contact_email" type="email" class="form-control form-control-sm" placeholder="Contact Email (required)" value="{{ cfg.ol_contact_email or '' }}" required>
      </div>
      <button class="btn btn-primary btn-sm">Save Open Library Config</button>
    </form>

    <h2 class="h5 mt-4">Job Retention</h2>
    <p class="text-muted small mb-2">Automatically delete old jobs and exported files.</p>
    <form method="post">
      <div class="mb-2">
        <div class="input-group" style="max-width: 180px;">
          <input type="number" name="job_retention_days" class="form-control form-control-sm" value="{{ cfg.job_retention_days or 30 }}" min="1" max="365" required>
          <span class="input-group-text">days</span>
        </div>
        <small class="text-muted d-block">Delete jobs older than this (default: 30)</small>
      </div>
      <button class="btn btn-primary btn-sm">Save</button>
    </form>
  </div>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h5 m-0">Export Templates</h2>
  <a href="{{ url_for('exports.template_new') }}" class="btn btn-sm btn-primary">
    <i class="fa-solid fa-plus"></i> New Template
  </a>
</div>

<p class="text-muted small mb-3">Manage Jinja2 templates for exporting highlights to various formats (Markdown, etc.).</p>

{% if templates %}
<div class="list-group">
  {% for template in templates %}
  <div class="list-group-item d-flex justify-content-between align-items-start">
    <div class="flex-grow-1">
      <h6 class="mb-1">
        {{ template.name }}
        {% if template.is_default %}
        <span class="badge bg-success ms-2">Default</span>
        {% endif %}
      </h6>
      <p class="mb-0 text-muted small">
        Created: {{ template.created_at.strftime('%b %d, %Y') }}
        {% if template.updated_at != template.created_at %}
        • Updated: {{ template.updated_at.strftime('%b %d, %Y') }}
        {% endif %}
      </p>
    </div>
    <div class="btn-group">
      <a href="{{ url_for('exports.template_edit', template_id=template.id) }}" class="btn btn-sm btn-outline-secondary">
        <i class="fa-solid fa-pen"></i> Edit
      </a>
      <form method="post" action="{{ url_for('exports.template_delete', template_id=template.id) }}" class="d-inline" onsubmit="return confirm('Delete template {{ template.name }}?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">
          <i class="fa-solid fa-trash"></i>
        </button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
  <i class="fa-solid fa-info-circle"></i> No templates configured. Create your first template to export highlights.
</div>
{% endif %}

<script>
  (function(){
    const input = document.getElementById('path-input');
    const list = document.getElementById('path-suggestions');
    let timer;
    function updateSuggestions() {
      const q = input.value || '';
      fetch(`/config/suggest?prefix=${encodeURIComponent(q)}`)
        .then(r => r.ok ? r.json() : {paths: []})
        .then(data => {
          const opts = (data.paths || []).map(p => `<option value="${p}"></option>`).join('');
          list.innerHTML = opts;
        })
        .catch(() => { list.innerHTML = ''; });
    }
    input.addEventListener('input', function(){
      clearTimeout(timer);
      timer = setTimeout(updateSuggestions, 150);
    });
    // Initial suggestions for convenience
    updateSuggestions();
  })();

  // Cron validation
  (function(){
    const scheduleInput = document.getElementById('scan-schedule-input');
    const saveBtn = document.getElementById('save-schedule-btn');
    const validationDiv = document.getElementById('schedule-validation');
    const form = document.getElementById('scan-schedule-form');
    let isValid = false;

    function validateCronExpression() {
      const expression = scheduleInput.value.trim();
      if (!expression) {
        validationDiv.innerHTML = '<div class="alert alert-danger alert-sm py-1 px-2 small">Cron expression cannot be empty</div>';
        saveBtn.disabled = true;
        isValid = false;
        return;
      }

      validationDiv.innerHTML = '<div class="alert alert-info alert-sm py-1 px-2 small">Validating...</div>';

      fetch(`/config/validate-cron?expression=${encodeURIComponent(expression)}`)
        .then(r => r.json())
        .then(data => {
          if (data.valid) {
            const nextRuns = data.next_runs.map(t => `<li class="small">${t}</li>`).join('');
            validationDiv.innerHTML = `
              <div class="alert alert-success alert-sm py-1 px-2 small">
                <strong>Valid!</strong> Next 3 runs:
                <ul class="mb-0 mt-1">${nextRuns}</ul>
              </div>
            `;
            saveBtn.disabled = false;
            isValid = true;
          } else {
            validationDiv.innerHTML = `<div class="alert alert-danger alert-sm py-1 px-2 small">${data.error}</div>`;
            saveBtn.disabled = true;
            isValid = false;
          }
        })
        .catch(err => {
          validationDiv.innerHTML = '<div class="alert alert-danger alert-sm py-1 px-2 small">Failed to validate cron expression</div>';
          saveBtn.disabled = true;
          isValid = false;
        });
    }

    // Validate on blur (leaving the input)
    scheduleInput.addEventListener('blur', validateCronExpression);

    // Validate on form submit
    form.addEventListener('submit', function(e) {
      if (!isValid) {
        e.preventDefault();
        validateCronExpression();
        return false;
      }
    });

    // Initial validation on page load
    validateCronExpression();
  })();
  </script>
{% endblock %}
